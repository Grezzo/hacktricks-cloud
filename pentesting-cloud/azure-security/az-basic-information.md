# Az - Basic Information

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Organization Hierarchy

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUchBvhjIdWWR2ldAkWiZMdmrcEYD9Ti5UAa3zAGr9YbAnx4Q_gZNp_zvOU429vgWZ_ixoYHQKdC8bGgkhWYCy591SRIFj6RKCj4BEpVQixAGsp3T3O5sS3k7x5CTaJ-SCBNC7i5KluLyxdiXoZsH1F0ko1Gv88=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption></figcaption></figure>

### Management Groups

* It can contain **other management groups or subscriptions**.
* This allows to **apply governance controls** such as RBAC and Azure Policy once at the management group level and have them **inherited** by all the subscriptions in the group.
* **10,000 management** groups can be supported in a single directory.
* A management group tree can support **up to six levels of depth**. This limit doesn‚Äôt include the root level or the subscription level.
* Each management group and subscription can support **only one parent**.
* Even if several management groups can be created **there is only 1 root management group**.
  * The root management group **contains** all the **other management groups and subscriptions** and **cannot be moved or deleted**.
* All subscriptions within a single management group must trust the **same Entra ID tenant.**

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption><p><a href="https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png">https://td-mainsite-cdn.tutorialsdojo.com/wp-content/uploads/2023/02/managementgroups-768x474.png</a></p></figcaption></figure>

### Azure Subscriptions

* It‚Äôs another **logical container where resources** (VMs, DBs‚Ä¶) can be run and will be billed.
* Its **parent** is always a **management group** (and it can be the root management group) as subscriptions cannot contain other subscriptions.
* It **trust only one Entra ID** directory
* **Permissions** applied at the subscription level (or any of its parents) are **inherited** to all the resources inside the subscription

### Resource Groups

[From the docs:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) A resource group is a **container** that holds **related resources** for an Azure solution. The resource group can include all the resources for the solution, or only those **resources that you want to manage as a group**. Generally, add **resources** that share the **same lifecycle** to the same resource group so you can easily deploy, update, and delete them as a group.

All the **resources** must be **inside a resource group** and can belong only to a group and if a resource group is deleted, all the resources inside it are also deleted.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfe8U30iP_vdZCvxX4g8nEPRLoo7v0kmCGkDn1frBPn3_GIoZ7VT2LkdsVQWCnrG_HSYNRRPM-1pSECUkbDAB-9YbUYLzpvKVLDETZS81CHWKYM4fDl3oMo5-yvTMnjdLTS2pz8U67xUTIzBhZ25MFMRkq5koKY=s2048?key=gSyKQr3HTyhvHa28Rf7LVA" alt=""><figcaption><p><a href="https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1">https://i0.wp.com/azuredays.com/wp-content/uploads/2020/05/org.png?resize=748%2C601&#x26;ssl=1</a></p></figcaption></figure>

### Azure Resource IDs

Every resource in Azure has an Azure Resource ID that identifies it.

The format of an Azure Resource ID is as follows:

* `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderNamespace}/{resourceType}/{resourceName}`

For a virtual machine named myVM in a resource group `myResourceGroup` under subscription ID `12345678-1234-1234-1234-123456789012`, the Azure Resource ID looks like this:

* `/subscriptions/12345678-1234-1234-1234-123456789012/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM`

## Azure vs Entra ID vs Azure AD Domain Services

### Azure

Azure is Microsoft‚Äôs comprehensive **cloud computing platform, offering a wide range of services**, including virtual machines, databases, artificial intelligence, and storage. It acts as the foundation for hosting and managing applications, building scalable infrastructures, and running modern workloads in the cloud. Azure provides tools for developers and IT professionals to create, deploy, and manage applications and services seamlessly, catering to a variety of needs from startups to large enterprises.

### Entra ID (formerly Azure Active Directory)

Entra ID is a cloud-based **identity and access management servic**e designed to handle authentication, authorization, and user access control. It powers secure access to Microsoft services such as Office 365, Azure, and many third-party SaaS applications. With features like single sign-on (SSO), multi-factor authentication (MFA), and conditional access policies among others.

### Entra Domain Services (formerly Azure AD DS)

Entra Domain Services extends the capabilities of Entra ID by offering **managed domain services compatible with traditional Windows Active Directory environments**. It supports legacy protocols such as LDAP, Kerberos, and NTLM, allowing organizations to migrate or run older applications in the cloud without deploying on-premises domain controllers. This service also supports Group Policy for centralized management, making it suitable for scenarios where legacy or AD-based workloads need to coexist with modern cloud environments.

## Entra ID Principals

### Users

* **New users**
  * Indicate email name and domain from selected tenant
  * Indicate Display name
  * Indicate password
  * Indicate properties (first name, job title, contact info‚Ä¶)
    * Default user type is ‚Äú**member**‚Äù
* **External users**
  * Indicate email to invite and display name (can be a non Microsft email)
  * Indicate properties
    * Default user type is ‚Äú**Guest**‚Äù

### Users Default permissions

* **Members (**[**docs**](https://learn.microsoft.com/en-gb/entra/fundamentals/users-default-permissions#restrict-member-users-default-permissions)**)**
  * Register Applications: Default **Yes**
  * Restrict non-admin users from creating tenants: Default **No**
  * Create security groups: Default **Yes**
  * Restrict access to Microsoft Entra administration portal: Default **No**
    * This doesn‚Äôt restrict API access to the portal (only web)
  * Allow users to connect work or school account with LinkedIn: Default **Yes**
  * Show keep user signed in: Default **Yes**
  * Restrict users from recovering the BitLocker key(s) for their owned devices: Default No (check in Device Settings)
  * Read other users: Default **Yes** (via Microsoft Graph)
* **Guests**
  * **Guest user access restrictions**
    * **Guest users have the same access as members** grants all member user permissions to guest users by default.
    * **Guest users have limited access to properties and memberships of directory objects (default)** restricts guest access to only their own user profile by default. Access to other users and group information is no longer allowed.
    * **Guest user access is restricted to properties and memberships of their own directory objects** is the most restrictive one.
  * **Guests can invite**
    * **Anyone in the organization can invite guest users including guests and non-admins (most inclusive) - Default**
    * **Member users and users assigned to specific admin roles can invite guest users including guests with member permissions**
    * **Only users assigned to specific admin roles can invite guest users**
    * **No one in the organization can invite guest users including admins (most restrictive)**
  * **External user leave**: Default **True**
    * Allow external users to leave the organization

{% hint style="success" %}
Even if restricted by default, users (members and guests) with granted permissions could perform the previous actions.
{% endhint %}

### **Service Principals**

A **Service Principal** is an **identity** created for **use** with **applications**, hosted services, and automated tools to access Azure resources. This access is **restricted by the roles assigned** to the service principal, giving you control over **which resources can be accessed** and at which level. For security reasons, it's always recommended to **use service principals with automated tools** rather than allowing them to log in with a user identity.

It's possible to **directly login as a service principal** by generating it a **secret** (password), a **certificate**, or granting **federated** access to third party platforms (e.g. Github Actions) over it.

* If you choose **password** auth (by default), **save the password generated** as you won't be able to access it again.
* If you choose certificate authentication, make sure the **application will have access over the private key**.

### App Registrations

An **App Registration** is a configuration that allows an application to integrate with Entra ID and to perform actions.

#### Key Components:

1. **Application ID (Client ID):** A unique identifier for your app in Azure AD.
2. **Redirect URIs:** URLs where Azure AD sends authentication responses.
3. **Certificates, Secrets & Federated Credentials:** It's possible to generate a secret or a certificate to login as the service principal of the application, or to grant federated access to it (e.g. Github Actions).&#x20;
   1. If a **certificate** or **secret** is generated, it's possible to a person to **login as the service principal** with CLI tools by knowing the **application ID**, the **secret** or **certificate** and the **tenant** (domain or ID).
4. **API Permissions:** Specifies what resources or APIs the app can access.
5. **Authentication Settings:** Defines the app's supported authentication flows (e.g., OAuth2, OpenID Connect).
6. **Service Principal**: A service principal is created when an App is created (if it's done from the web console) or when it's installed in a new tenant.
   1. The **service principal** will get all the requested permissions it was configured with.

### Enterprise Applications

It‚Äôs just a **table in Azure to filter service principals** and check the applications that have been assigned to.

**It isn‚Äôt another type of ‚Äúapplication‚Äù,** there isn‚Äôt any object in Azure that is an ‚ÄúEnterprise Application‚Äù, it‚Äôs just an abstraction to check the Service principals, App registrations and managed identities.

### **Managed Identity (Metadata)**

Managed identities in Azure Active Directory offer a solution for **automatically managing the identity** of applications. These identities are used by applications for the purpose of **connecting** to **resources** compatible with Azure Active Directory (**Azure AD**) authentication. This allows to **remove the need of hardcoding cloud credentials** in the code as the application will be able to contact the **metadata** service to get a valid token to **perform actions** as the indicated managed identity in Azure.

There are two types of managed identities:

* **System-assigned**. Some Azure services allow you to **enable a managed identity directly on a service instance**. When you enable a system-assigned managed identity, a **service principal** is created in the Entra ID tenant trusted by the subscription where the resource is located. When the **resource** is **deleted**, Azure automatically **deletes** the **identity** for you.
* **User-assigned**. It's also possible for users to generate managed identities. These are created inside a resource group inside a subscription and a service principal will be created in the EntraID trusted by the subscription. Then, you can assign the managed identity to one or **more instances** of an Azure service (multiple resources). For user-assigned managed identities, the **identity is managed separately from the resources that use it**.

Managed Identities **don't generate eternal credentials** (like passwords or certificates) to access as the service principal attached to it.

### Default Consent Permissions

**User consent for applications**

* **Do not allow user consent**
  * An administrator will be required for all apps.
* **Allow user consent for apps from verified publishers, for selected permissions (Recommended)**
  * All users can consent for permissions classified as "low impact", for apps from verified publishers or apps registered in this organization.
  * **Default** low impact permissions (although you need to accept to add them as low):
    * User.Read - sign in and read user profile
    * offline\_access - maintain access to data that users have given it access to
    * openid - sign users in
    * profile - view user's basic profile
    * email - view user's email address
* **Allow user consent for apps (Default)**
  * All users can consent for any app to access the organization's data.

**Admin consent requests**: Default **No**

* Users can request admin consent to apps they are unable to consent to
* If **Yes**: It‚Äôs possible to indicate Users, Groups and Roles that can consent requests
  * Configure also if users will receive email notifications and expiration reminders&#x20;

### Administrative Units

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Administrative units let you **subdivide** your organization into **any unit** that you want, and then **assign specific administrators** that can **manage only the members** of that unit. For example, you could use administrative units to delegate permissions to administrators of each school at a large university, so they could control access, manage users, and set policies only in the School of Engineering.

Only **users**, **groups** and **devices** can be **members** of an **administrative unit**.

Therefore, an **Administrative unit** will **contain** some **members** and other **principals** will be **assigned permissions over that** administrative **unit** that they can use to **manage the members** of the administrative unit.

## Roles & Permissions

**Roles** are **assigned** to **principals** on a **scope**: `principal -[HAS ROLE]->(scope)`

**Roles** assigned to **groups** are **inherited** by all the **members** of the group.

Depending on the scope the role was assigned to, the **role** cold be **inherited** to **other resources** inside the scope container. For example, if a user A has a **role on the subscription**, he will have that **role on all the resource groups** inside the subscription and on **all the resources** inside the resource group.

### **Classic Roles**

| **Owner**                     | <ul><li>Full access to all resources</li><li>Can manage access for other users</li></ul> | All resource types |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributor**               | <ul><li>Full access to all resources</li><li>Cannot manage access</li></ul>              | All resource types |
| **Reader**                    | ‚Ä¢ View all resources                                                                     | All resource types |
| **User Access Administrator** | <ul><li>View all resources</li><li>Can manage access for other users</li></ul>           | All resource types |

### Built-In roles

[From the docs: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) has several Azure **built-in roles** that you can **assign** to **users, groups, service principals, and managed identities**. Role assignments are the way you control **access to Azure resources**. If the built-in roles don't meet the specific needs of your organization, you can create your own [**Azure custom roles**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Built-In** roles apply only to the **resources** they are **meant** to, for example check this 2 examples of **Built-In roles over Compute** resources:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Provides permission to backup vault to perform disk backup.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | View Virtual Machines in the portal and login as a regular user. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

This roles can **also be assigned over logic containers** (such as management groups, subscriptions and resource groups) and the principals affected will have them **over the resources inside those containers**.

* Find here a list with [**all the Azure built-in roles**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Find here a list with [**all the Azure AD built-in roles**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Custom Roles

Azure also allow to create [**custom roles**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) with the permissions the user needs.

### Permission Denied

* In order for a **principal to have some access over a resource** he needs an explicit role being granted to him (anyhow) **granting him that permission**.
* An explicit **deny role assignment takes precedence** over the role granting the permission.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Global Administrator

Users with the Global Administrator role has the ability to '**elevate' to User Access Administrator Azure role to the root management group**. This means that a Global Administrator will be able to manage access **all Azure subscriptions and management groups.**\
This elevation can be done at the end of the page: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

Azure policies are a set of **rules and regulations in Microsoft Azur**e, a cloud computing service, that help manage and enforce organizational standards and to assess compliance at-scale. These policies enforce different rules over your **Azure resources**, ensuring that those resources stay compliant with corporate standards and service level agreements.

Azure policies are crucial for cloud governance and security, helping to ensure that resources are used properly and efficiently, and that they comply with external regulations and internal policies.\
Som examples:

1. **Ensuring Compliance with Specific Azure Regions**: This policy ensures that all resources are deployed in specific Azure regions. For example, a company might want to ensure all its data is stored in Europe for GDPR compliance.
2. **Enforcing Naming Standards**: Policies can enforce naming conventions for Azure resources. This helps in organizing and easily identifying resources based on their names, which is helpful in large environments.
3. **Restricting Certain Resource Types**: This policy can restrict the creation of certain types of resources. For example, a policy could be set to prevent the creation of expensive resource types, like certain VM sizes, to control costs.
4. **Enforcing Tagging Policies**: Tags are key-value pairs associated with Azure resources used for resource management. Policies can enforce that certain tags must be present, or have specific values, for all resources. This is useful for cost tracking, ownership, or categorization of resources.
5. **Limiting Public Access to Resources**: Policies can enforce that certain resources, like storage accounts or databases, do not have public endpoints, ensuring that they are only accessible within the organization's network.
6. **Automatically Applying Security Settings**: Policies can be used to automatically apply security settings to resources, such as applying a specific network security group to all VMs or ensuring that all storage accounts use encryption.

Note that Azure Policies can be attached to any level of the Azure hierarchy, but they are **commonly used in the root management group** or in other management groups.

### Permissions Scope

In Azure **permissions are can be assigned to any part of the hierarchy**. That includes management groups, subscriptions, resource groups, and individual resources. Permissions are **inherited** by contained **resources** of the entity where they were assigned.

This hierarchical structure allows for efficient and scalable management of access permissions.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (role-based access control) is what we have seen already in the previous sections: **Assigning a role to a principal to grant him access** over a resource.\
However, in some cases you might want to provide **more fined-grained access management** or **simplify** the management of **hundreds** of role **assignments**.

Azure **ABAC** (attribute-based access control) builds on Azure RBAC by adding **role assignment conditions based on attributes** in the context of specific actions. A _role assignment condition_ is an **additional check that you can optionally add to your role assignment** to provide more fine-grained access control. A condition filters down permissions granted as a part of the role definition and role assignment. For example, you can **add a condition that requires an object to have a specific tag to read the object**.\
You **cannot** explicitly **deny** **access** to specific resources **using conditions**.

### Default User Permissions

A basic user will have some **default permissions** to enumerate some parts of AzureAD:

* Read all users, Groups, Applications, Devices, Roles, Subscriptions, and their public properties
* Invite Guests (_can be turned off_)
* Create Security groups
* Read non-hidden Group memberships
* Add guests to Owned groups
* Create new application (_can be turned off_)
* Add up to 50 devices to Azure (_can be turned off_)

You can see the full [list of **default permissions of users** in the docs](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Moreover, note that in that list you can also see the **guests default permissions list**.

{% hint style="info" %}
Remember that to enumerate Azure resources the user needs an explicit grant of the permission.
{% endhint %}

### Privileged Identity Management (PIM)

Privileged Identity Management (PIM) in Azure is a tool that **manages, controls, and monitors privileged access** in Azure Active Directory and Azure. It enhances security by providing **just-in-time and time-limited privileged access**, **enforcing approval workflows, and requiring additional authentication**. This approach minimizes the risk of unauthorized access by ensuring that elevated permissions are granted only when necessary and for a specific duration.

## Authentication Tokens

There are **three types of tokens** used in OIDC:

* [**Access Tokens**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** The client presents this token to the resource server to **access resources**. It can be used only for a specific combination of user, client, and resource and **cannot be revoked** until expiry - that is 1 hour by default. Detection is low using this.
* **ID Tokens**: The client receives this **token from the authorization server**. It contains basic information about the user. It is **bound to a specific combination of user and client**.
* **Refresh Tokens**: Provided to the client with access token. Used to **get new access and ID tokens**. It is bound to a specific combination of user and client and can be revoked. Default expiry is **90 days** for inactive refresh tokens and **no expiry for active tokens**.

{% hint style="warning" %}
Information for **conditional access** is **stored** inside the **JWT**. So, if you request the **token from an allowed IP address**, that **IP** will be **stored** in the token and then you can use that token from a **non-allowed IP to access the resources**.
{% endhint %}

Check the following page to learn different ways to **request access tokens** and login with them:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

The most common API endpoints are:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph which is deprecated is graph.windows.net)

## References

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)
* [https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration](https://stackoverflow.com/questions/65922566/what-are-the-differences-between-service-principal-and-app-registration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
